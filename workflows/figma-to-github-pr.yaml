name: "Figma to GitHub Pull Request"
description: "GitHub MCP를 활용한 자동 PR 생성 파이프라인"

tasks:
  # 1. Figma 디자인 분석
  - id: "analyze-figma-changes"
    mcp: "figma-mcp"
    action: "detect-design-changes"
    params:
      figmaFileId: "${input.figmaFileId}"
      lastSync: "${context.lastSyncTime}"
    timeout: 30000

  # 2. Next.js 컴포넌트 생성
  - id: "generate-components"
    mcp: "nextjs-mcp"
    action: "create-react-components"
    dependsOn: ["analyze-figma-changes"]
    params:
      designData: "${tasks.analyze-figma-changes.output}"
      outputDir: "./src/components/generated"
      generateTypes: true
    timeout: 45000

  # 3. GitHub 브랜치 생성
  - id: "create-feature-branch"
    mcp: "github-mcp"
    action: "create-branch"
    dependsOn: ["generate-components"]
    params:
      repository: "${config.github.repository}"
      branchName: "feature/design-update-${timestamp}"
      baseBranch: "main"
    timeout: 15000

  # 4. 변경사항 커밋
  - id: "commit-changes"
    mcp: "github-mcp"
    action: "commit-files"
    dependsOn: ["create-feature-branch"]
    params:
      repository: "${config.github.repository}"
      branch: "${tasks.create-feature-branch.output.branchName}"
      files: "${tasks.generate-components.output.files}"
      message: |
        🎨 Auto-generated components from Figma

        ## Changes Summary
        ${tasks.analyze-figma-changes.output.changesSummary}

        ## Generated Components
        ${tasks.generate-components.output.componentsList}

        ## Design Tokens Updated
        ${tasks.analyze-figma-changes.output.tokensChanged}

        ---
        - Figma File: ${input.figmaFileId}
        - Generated by: TaskManager MCP Pipeline
        - Timestamp: ${timestamp}

        [auto-commit]
    timeout: 30000

  # 5. Pull Request 생성
  - id: "create-pull-request"
    mcp: "github-mcp"
    action: "create-pull-request"
    dependsOn: ["commit-changes"]
    params:
      repository: "${config.github.repository}"
      title: "🎨 Design Update: ${tasks.analyze-figma-changes.output.changesSummary}"
      description: |
        ## 🎨 자동 생성된 디자인 업데이트

        이 PR은 Figma 디자인 변경사항을 자동으로 감지하여 생성되었습니다.

        ### 📋 변경 사항
        ${tasks.analyze-figma-changes.output.detailedChanges}

        ### 🧩 생성된 컴포넌트
        ${tasks.generate-components.output.componentsList}

        ### 🎨 디자인 토큰
        ${tasks.analyze-figma-changes.output.tokensChanged}

        ### 🔗 참고 링크
        - **Figma**: ${input.figmaFileUrl}
        - **브랜치**: `${tasks.create-feature-branch.output.branchName}`
        - **커밋**: ${tasks.commit-changes.output.commitUrl}

        ### ✅ 체크리스트
        - [ ] 디자인 검토 완료
        - [ ] 컴포넌트 테스트 확인
        - [ ] 접근성 검토
        - [ ] 반응형 확인

        ---
        *🤖 이 PR은 TaskManager MCP에 의해 자동 생성되었습니다.*
      head: "${tasks.create-feature-branch.output.branchName}"
      base: "main"
      reviewers: ["${config.github.defaultReviewers}"]
      labels: ["design-system", "auto-generated", "figma-sync", "needs-review"]
    timeout: 20000

  # 6. 팀 알림 (Slack 등)
  - id: "notify-team"
    mcp: "notification-mcp"
    action: "send-notification"
    dependsOn: ["create-pull-request"]
    params:
      channels: ["#design-system", "#frontend-team"]
      message: |
        🎨 **새로운 디자인 업데이트 PR이 생성되었습니다!**

        **PR**: ${tasks.create-pull-request.output.prUrl}
        **변경사항**: ${tasks.analyze-figma-changes.output.changesSummary}
        **리뷰어**: ${config.github.defaultReviewers}

        리뷰 부탁드립니다! 🙏
    timeout: 10000

# 에러 처리 전략
errorHandling:
  strategy: "rollback"
  rollbackActions:
    - task: "create-feature-branch"
      action: "delete-branch"
    - task: "commit-changes"
      action: "reset-branch"

# 알림 설정
notifications:
  onSuccess:
    - type: "console"
      message: "🎉 Figma to GitHub PR pipeline completed successfully!"
  onError:
    - type: "console"
      message: "❌ Pipeline failed. Check logs for details."
  onProgress:
    - type: "console"
      message: "⚡ Task ${task.id} in progress..."

# 설정값
config:
  github:
    repository: "your-org/your-repo"
    defaultReviewers: ["developer1", "designer1"]
